<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <title>Melanie IA 游뱄</title>
    <style>
        /* 1. Estilos para el fondo din치mico (particles-js) */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            background-color: #1a1a2e;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: 50% 50%;
            z-index: -1;
        }

        /* 2. Estilos base del cuerpo de la p치gina */
        body {
            /* Usamos Roboto como fuente general */
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: transparent; 
            color: #ddd; 
        }

        /* 3. Contenedor principal: ESTILO BASE DE ESCRITORIO */
        .main-content {
            max-width: 600px; 
            width: 90vw; 
            margin: 50px auto;
            padding: 25px; /* M치s padding para que respire */
            background-color: rgba(30, 30, 50, 0.95); /* Fondo ligeramente m치s oscuro */
            border-radius: 15px; /* Bordes m치s suaves */
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
            z-index: 10;
            min-height: 500px; 
            display: flex; /* A침adido para mejor control */
            flex-direction: column;
        }

        /* 4. T칤tulo con fuente profesional */
        h1 {
            /* Usamos Poppins para el t칤tulo */
            font-family: 'Poppins', sans-serif;
            color: #ffffff;
            font-size: 2.2em; /* T칤tulo m치s grande */
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 1px;
            color: #7a7acf; /* Color azulado profesional */
        }
        
        /* 5. MEDIA QUERY: AJUSTE ESPEC칈FICO PARA PANTALLAS PEQUE칌AS */
        @media (max-width: 650px) {
            .main-content {
                width: 95%; 
                margin: 10px auto; 
                padding: 15px;
            }
            h1 {
                font-size: 1.8em;
            }
        }

        /* 6. Estilos de la ventana de mensajes */
        #chat-output {
            flex-grow: 1; /* Permite que la ventana ocupe el espacio restante */
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #4a4a6e;
            border-radius: 10px;
            background-color: #24243e; /* Fondo de chat m치s oscuro */
            /* Transici칩n suave para el scroll (no siempre funciona en todos los navegadores) */
            scroll-behavior: smooth; 
        }

        /* 7. Estilos de los mensajes */
        .user-msg {
            text-align: right;
            color: #92e6a7; 
            margin-bottom: 10px;
            padding: 5px 0;
        }

        .ia-msg {
            text-align: left;
            color: #cccccc;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #38385e; 
            border-radius: 8px;
        }
        
        /* 8. Estilo para el efecto de escritura (animaci칩n) */
        .typing-animation {
            /* Ocultamos el texto hasta que la animaci칩n lo revele */
            white-space: nowrap; 
            /* Esto crear치 el efecto de cursor */
            border-right: .15em solid #92e6a7; 
            overflow: hidden;
            animation: blink-caret .75s step-end infinite;
            display: inline-block; /* Importante para el cursor */
        }
        
        /* Animaci칩n para el cursor parpadeante */
        @keyframes blink-caret {
          from, to { border-color: transparent }
          50% { border-color: #92e6a7; }
        }

        /* 9. Caja de entrada de texto y bot칩n */
        .input-area {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #4a4a6e;
            border-radius: 8px;
            background-color: #1a1a2e;
            color: #ddd;
            font-size: 1em;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: #5a5acd; 
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1em;
        }

        button:hover {
            background-color: #7a7acf;
        }
    </style>
</head>
<body>
    
    <div id="particles-js"></div> 
    
    <div class="main-content"> 
        <h1>Melanie IA 游뱄</h1>
        <div id="chat-output">
            <div class="ia-msg">춰Hola! Soy Melanie, una asistente de IA lista para ayudarte. 쮼n qu칠 puedo serte 칰til hoy?</div>
        </div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="Escribe tu consulta..." onkeypress="if(event.key === 'Enter') enviarMensaje()">
            <button onclick="enviarMensaje()">Enviar</button>
        </div>
    </div>
    
<script>
    const CHAT_API_URL = '/api/chat'; 
    let conversationHistory = []; 

    function appendMessage(sender, text, isFinal=true) {
        const output = document.getElementById('chat-output');
        const className = sender === 'user' ? 'user-msg' : 'ia-msg';
        const senderLabel = sender === 'user' ? 'T칰: ' : 'IA: ';
        
        const newDiv = document.createElement('div');
        newDiv.className = className;
        newDiv.innerHTML = `${senderLabel}${text}`;
        
        output.appendChild(newDiv);
        output.scrollTop = output.scrollHeight;

        if (isFinal) {
             // Solo a침adimos la respuesta final al historial
             if (sender === 'ia') {
                 conversationHistory.push({ role: 'model', text: text });
             } else {
                 conversationHistory.push({ role: 'user', text: text });
             }
        }
    }

    async function enviarMensaje() {
        const input = document.getElementById('user-input');
        const userPrompt = input.value.trim();
        
        if (userPrompt === "") return;

        // A침adimos el mensaje del usuario al historial
        // Nota: El historial se almacena en el formato que espera el servidor {role: 'user', text: '...'}
        appendMessage('user', userPrompt, false); // A침adimos visualmente, pero la data ya se almacena en el fetch

        // Almacenamos el mensaje del usuario antes de limpiar el input
        conversationHistory.push({ sender: 'user', text: userPrompt });
        input.value = '';

        // Mostramos el mensaje temporal
        appendMessage('ia', '...Escribiendo respuesta (Melanie est치 consultando)...', false);
        const thinkingMessage = document.querySelector('#chat-output div:last-child');
        
        try {
            const response = await fetch(CHAT_API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ 
                    userPrompt: userPrompt, 
                    // Enviamos todo el historial, incluyendo el 칰ltimo prompt del usuario
                    history: conversationHistory 
                })
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status} o Fall칩 la conexi칩n de red`);
            }

            const result = await response.json();
            const iaResponseText = result.response;
            
            // ----------------------------------------------------
            // IMPLEMENTACI칍N DE EFECTO DE ESCRITURA (Tipo ChatGPT)
            // ----------------------------------------------------
            
            // 1. Reemplazamos el mensaje temporal
            const finalDiv = document.createElement('div');
            finalDiv.className = 'ia-msg';
            finalDiv.innerHTML = 'IA: '; // El prefijo
            const span = document.createElement('span');
            // La clase .typing-animation solo aplica el cursor parpadeante (el texto aparece por JS)
            span.classList.add('typing-animation'); 
            finalDiv.appendChild(span);
            thinkingMessage.replaceWith(finalDiv);

            // 2. Ejecutamos la animaci칩n de escritura
            let i = 0;
            const speed = 20; // velocidad en ms (ajusta esto si quieres que escriba m치s r치pido o lento)
            const output = document.getElementById('chat-output');

            function typeWriter() {
                if (i < iaResponseText.length) {
                    span.textContent += iaResponseText.charAt(i);
                    i++;
                    output.scrollTop = output.scrollHeight; // Mantiene el scroll abajo
                    setTimeout(typeWriter, speed);
                } else {
                    // 3. Cuando termina, quitamos el efecto y a침adimos la respuesta al historial
                    span.classList.remove('typing-animation');
                    // Almacenamos la respuesta de la IA en el historial despu칠s de que se termina de escribir
                    conversationHistory.push({ sender: 'model', text: iaResponseText });
                }
            }
            typeWriter();
            

        } catch (error) {
            console.error('Error al comunicarse con el servidor:', error);
            // Si falla, mostramos el error
            thinkingMessage.textContent = `IA: 丘멆잺 Error: Fall칩 la comunicaci칩n con la IA. Detalle: ${error.message}`;
        }
    }    
</script>

<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<script>
    // Inicializar la librer칤a particles.js (sin cambios)
    particlesJS('particles-js', {
      "particles": {
        "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#ffffff" },
        "shape": { "type": "circle" },
        "opacity": { "value": 0.5, "random": false },
        "size": { "value": 3, "random": true },
        "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1 },
        "move": { "enable": true, "speed": 6, "direction": "none", "random": false, "straight": false, "out_mode": "out", "bounce": false }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": {
          "onhover": { "enable": true, "mode": "repulse" },
          "onclick": { "enable": true, "mode": "push" },
          "resize": true
        },
        "modes": {
          "repulse": { "distance": 100, "duration": 0.4 }
        }
      },
      "retina_detect": true
    });
</script>

</body>
</html>
